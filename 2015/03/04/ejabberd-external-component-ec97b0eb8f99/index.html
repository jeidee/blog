<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>ejabberd external component 연동</title>
	
	
	<link rel="stylesheet" href="https://jeidee.github.io/css/style.css">
	
	<meta name="generator" content="Hugo 0.31.1" />
</head>
<body>
	<header>
		<a href="https://jeidee.github.io/">Erlang &amp; Go</a>
		<nav>
			<ul>
				
			</ul>
		</nav>
	</header>
	<main>
		<article>
			<h1>ejabberd external component 연동</h1>
			<time>04.03.2015 00:00</time>
			<div>
				

<h2 id="xmpp-component-개요">xmpp component 개요</h2>

<p>xmpp에는 external component 관련 공식 프로토콜인 <a href="http://xmpp.org/extensions/xep-0114.html">Jabber Component Protocol</a>이 있다.</p>

<p>Jabber Component Protocol은 외부 컴포넌트를 XMPP서버와 연동하기 위한 규약을 제안하는데 크게 accept와 connect에 대한 XML 스키마와 handshake flow를 명세하고 있다.</p>

<p>xmpp의 external component는 프로토콜만 준수한다면 어떤 언어를 사용해서도 구현할 수 있다. 3rd-party 컴포넌트를 ejabberd와 연동하는 방법은 <a href="https://www.ejabberd.im/tutorials-transports">Install Components and Transports to othe networks</a> 문서를 참고하도록 한다.</p>

<h2 id="echo-bot-component-만들어서-연동해-보기">echo-bot component 만들어서 연동해 보기</h2>

<p>node-xmpp-component 모듈을 사용해서 간단한 에코봇을 컴포넌트로 만들어 ejabberd와 연동해 보도록 하자.</p>

<p>우선 다음과 같이 node-xmpp-component와 node-xmpp-core를 설치한다.</p>

<pre><code>  
$ npm install node-xmpp-component
  
$ npm install node-xmpp-core
  
</code></pre>

<p>다음과 같이 에코 봇을 작성한다.</p>

<pre><code class="language-javascript">  
var Component = require('node-xmpp-component')
      
, argv = process.argv
      
, ltx = require('node-xmpp-core').ltx

if (argv.length &lt; 6) {
      
console.error('Usage: node echo_bot.js &lt;my-jid&gt; &lt;my-password&gt; ' +
      
'&lt;server&gt; &lt;port&gt;')
      
process.exit(1)
  
}

var component = new Component({
      
jid: argv[2],
      
password: argv[3],
      
host: argv[4],
      
port: Number(argv[5]),
      
reconnect: true
  
})

component.on('online', function() {
      
console.log('Component is online')

component.on('stanza', function(stanza) {
          
console.log('Received stanza: ', stanza)
          
if (stanza.is('message') &amp;&amp; stanza.attrs.type === 'chat') {
              
var i = parseInt(stanza.getChildText('body'))
              
var reply = new ltx.Element('message', { to: stanza.attrs.from, from: stanza.attrs.to, type: 'chat' })
              
reply.c('body').t(stanza)
              
component.send(reply)
          
}
      
})
  
})

component.on('offline', function () {
      
console.log('Component is offline')
  
})

component.on('connect', function () {
      
console.log('Component is connected')
  
})

component.on('reconnect', function () {
      
console.log('Component reconnects …')
  
})

component.on('disconnect', function (e) {
      
console.log('Component is disconnected', e)
  
})

component.on('error', function(e) {
      
console.error(e)
      
process.exit(1)
  
})

process.on('exit', function () {
      
component.end()
  
})
  
</code></pre>

<p>ejabberd.yml을 다음과 같이 수정한다.</p>

<pre><code>  
##
    
\## ejabberd_service: Interact with external components (transports, &amp;#8230;)
    
##
    
&amp;#8211;
       
port: 8888
       
module: ejabberd_service
       
access: all
       
shaper_rule: fast
       
ip: &quot;127.0.0.1&quot;
       
hosts:
         
&quot;foo.hello.world&quot;:
           
password: &quot;foo&quot;

</code></pre>

<p>ejabberd를 시작한 후 다음과 같이 컴포넌트를 시작한다.</p>

<pre><code>  
$ ejabberdctl start
  
$ node echo_bot.js foo.hello.world foo localhost 8888
  
</code></pre>

<p>정상적으로 연결이 될 경우 다음과 같은 메세지가 출력된다.</p>

<pre><code>  
Component is connected
  
Component is online
  
</code></pre>

<p>이 상태에서 XMPP 클라이언트로 접속한 후 foo.hello.world에게 메세지를 전송해 보자.</p>

<p>문제가 없을 경우 보낸 메세지가 다시 내게로 돌아오게 된다.</p>

<h2 id="활용">활용</h2>

<p>xmpp component의 활용은 다양하게 활용될 수 있다. 다른 메신저 서비스에 메세지 라우팅을 하거나, 날씨/사전/FAQ등의 봇 서비스에 활용될 수도 있다.</p>

<h2 id="참고">참고</h2>

<ul>
<li><a href="https://www.ejabberd.im/tutorials-transports">Install Components and Transports to Other Networks</a></li>
<li><a href="https://www.ejabberd.im/node/5134">Configuring Ejabberd to use an external component (with XEP-0114)</a></li>
<li><a href="http://xmpp.org/extensions/xep-0114.html">Jabber Component Protocol</a></li>
<li><a href="https://github.com/node-xmpp/node-xmpp-component">node-xmpp-component</a></li>
</ul>

			</div>
			<div>
				<ul id="tags">
					
					<li><a href="/tags/bot">bot</a> </li>
					
					<li><a href="/tags/component">component</a> </li>
					
				</ul>
			</div>
			<div>
				
			</div>
		</article>
	</main>
	<aside>
		<div>
			<div>
				<h3>LATEST POSTS</h3>
			</div>
			<div>
				<ul>
					
					<li><a href="https://jeidee.github.io/2017/08/31/upstart-ec84a4eca095/">upstart 설정</a></li>
					
					<li><a href="https://jeidee.github.io/2017/06/08/centosec9790ec849c-mongodb-ec84a4ecb998ec9980-service-eb93b1eba19d/">CentOS에서 MongoDB 설치와 Service 등록</a></li>
					
					<li><a href="https://jeidee.github.io/2017/01/25/couchbase-cberlec9790-lcb_cntl-ed95a8ec8898-ecb694eab080/">couchbase cberl에 lcb_cntl 함수 추가</a></li>
					
					<li><a href="https://jeidee.github.io/2017/01/25/couchbase-cberlec9d98io-pluginec9d84-libeventeba19c-ebb380eab2bd/">couchbase cberl의IO Plugin을 libevent로 변경</a></li>
					
					<li><a href="https://jeidee.github.io/2017/01/25/ejabberdec9d98-deps-eb9dbcec9db4ebb88ceb9faceba6ac-ec8898eca095-ed9b84-ecbbb4ed8c8cec9dbcec9790ec849c-eb8884eb9dbdeb90a0-eb958c/">ejabberd의 deps 라이브러리 수정 후 컴파일에서 누락될 때</a></li>
					
				</ul>
			</div>
		</div>
	</aside>

	<footer>
		<p>&copy; 2017 <a href="https://jeidee.github.io/">Erlang &amp; Go</a></p>
	</footer>
</body>
</html>