<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" android ndk, native c/c&#43;&#43; 코드에서 java 코드 호출 &middot;  Erlang &amp; Go" />
  	<meta property="og:site_name" content="Erlang &amp; Go" />
  	<meta property="og:url" content="https://jeidee.github.io/2015/04/22/android-ndk-native-cc-ecbd94eb939cec9790ec849c-java-ecbd94eb939c-ed98b8ecb69c/" />
    
    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2015-04-22T00:00:00Z" />

    
    <meta property="og:article:tag" content="callback" />
    
    <meta property="og:article:tag" content="ndk" />
    
    

  <title>
     android ndk, native c/c&#43;&#43; 코드에서 java 코드 호출 &middot;  Erlang &amp; Go
  </title>

    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://jeidee.github.ioimages/favicon.ico">
	  <link rel="apple-touch-icon" href="https://jeidee.github.ioimages/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://jeidee.github.iocss/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://jeidee.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="Erlang &amp; Go" />
      
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="https://jeidee.github.io/2015/04/22/android-ndk-native-cc-ecbd94eb939cec9790ec849c-java-ecbd94eb939c-ed98b8ecb69c/" />

    
<div id="particles-js"></div>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://jeidee.github.iojs/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">



<header class="main-header " style="background-image: url(https://jeidee.github.io)">
    
    <nav class="main-nav overlay clearfix">
        
        
    </nav>
<div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">
              <a class="btn-bootstrap-2" href="#content">Erlang &amp; Go</a>
          </h1>
          <h2 class="page-description"></h2>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

  <main id="content" class="content" role="main">


  <article class="post posts">

    <header class="post-header">
        <h1 class="post-title">android ndk, native c/c&#43;&#43; 코드에서 java 코드 호출</h1>
        <section class="post-meta">
        
         
          <span class="post-tag small"><a href="https://jeidee.github.iotags/callback/">#callback</a></span>
         
          <span class="post-tag small"><a href="https://jeidee.github.iotags/ndk/">#ndk</a></span>
         
        </section>
    </header>
  
    <section class="post-content">
      

<p>다음과 같이 두 가지 측면에서 접근할 수 있다.</p>

<ul>
<li>동일 쓰레드에서 jni call(java코드에서 native c/c++ 함수 호출)을 하고, 동일 스코프에서 java object의 함수를 호출하는 경우</li>
<li>호출측(java) 쓰레드와 콜백(native c/c++) 쓰레드가 다른 경우</li>
</ul>

<h2 id="동일-쓰레드에서-콜백-구현">동일 쓰레드에서 콜백 구현</h2>

<p>java</p>

<pre><code class="language-java">  
package com.jeidee.glooxforandroid;

public TestClient {
      
public native callbackTest();

public void testCallback(String param) {
          
Log.d(&quot;JNI&quot;, param);
      
}
  
}
  
</code></pre>

<p>native c++</p>

<pre><code class="language-cpp">  
include &quot;com\_jeidee\_glooxforandroid_NativeCall.h&quot;

#include &quot;client.h&quot;

JNIEXPORT void JNICALL Java\_com\_jeidee\_glooxforandroid\_NativeCall_callbackTest (JNIEnv *env, jobject obj) {
      
static jmethodID cb = NULL;
      
jclass cls = env-&gt;GetObjectClass(obj);

if (cb == NULL) {
          
cb = env-&gt;GetMethodID(cls, &quot;testCallback&quot;, &quot;(Ljava/lang/String;)V&quot;);
          
if (cb == NULL) return;
      
}

env-&gt;CallVoidMethod(obj, cb, env-&gt;NewStringUTF(&quot;call testCallback()&quot;));
  
}
  
</code></pre>

<p>JNI함수인 callbackTest()를 호출한 java측 object에 testCallback(String) 함수가 있을 경우 위의 코드는 정상 동작한다.</p>

<h2 id="서로-다른-쓰레드에서-콜백-구현">서로 다른 쓰레드에서 콜백 구현</h2>

<p>예를 들어, 소켓 클라이언트를 native c/c++ 코드로 구현했다고 가정해 보자.</p>

<p>클라이언트가 서버에 접속 후 서버에서 데이터를 수신했을때 java 코드에 콜백한다고 한다면,</p>

<p>데이터 수신하는 쓰레드(보통은 native 측에서 쓰레드 구현)와 호출측(java ui 쓰레드)의 쓰레드는 다르다.</p>

<p>이럴 경우 간단하게 콜백 받을 java측의 클래스에 static method를 생성해 다음과 같이 구현할 수 있다.</p>

<p>java</p>

<pre><code class="language-java">  
public TestClient {
      
public native callbackTest();

public static void testCallback(String param) {
          
Log.d(&quot;JNI&quot;, param);
      
}
  
}
  
</code></pre>

<p>native c++</p>

<pre><code class="language-cpp">  
JNIEnv\* getJNIEnv(JavaVM\* jvm)
  
{

if (NULL == jvm) {
          
LOGD(&quot;Failed to get JNIEnv. JniHelper::getJavaVM() is NULL&quot;);
          
return NULL;
      
}

JNIEnv *env = NULL;
      
// get jni environment
      
jint ret = jvm-&gt;GetEnv((void**)&amp;env, JNI\_VERSION\_1_4);

switch (ret) {
          
case JNI_OK :
              
// Success!
              
return env;

case JNI_EDETACHED :
              
// Thread not attached

// TODO : If calling AttachCurrentThread() on a native thread
              
// must call DetachCurrentThread() in future.
              
// see: http://developer.android.com/guide/practices/design/jni.html

if (jvm-&gt;AttachCurrentThread(&amp;env, NULL) &lt; 0)
              
{
                  
LOGD(&quot;Failed to get the environment using AttachCurrentThread()&quot;);
                  
return NULL;
              
} else {
                  
// Success : Attached and obtained JNIEnv!
                  
return env;
              
}

case JNI_EVERSION :
              
// Cannot recover from this error
              
LOGD(&quot;JNI interface version 1.4 not supported&quot;);
          
default :
              
LOGD(&quot;Failed to get the environment using GetEnv()&quot;);
              
return NULL;
      
}
  
}

// get class and make it a global reference, release it at endJni().
  
jclass getClassID(JNIEnv \*pEnv, const char\* className)
  
{
      
jclass ret = pEnv-&gt;FindClass(className);
      
if (! ret)
      
{
          
LOGD(&quot;Failed to find class of %s&quot;, className);
      
}

return ret;
  
}

bool getStaticMethodInfo(JavaVM\* jvm, JniMethodInfo &amp;methodinfo, const char\* className, const char \*methodName, const char \*paramCode)
  
{
      
jmethodID methodID = 0;
      
JNIEnv *pEnv = 0;
      
bool bRet = false;

do
      
{
          
pEnv = getJNIEnv(jvm);
          
if (! pEnv)
          
{
              
break;
          
}

jclass classID = getClassID(pEnv, className);

methodID = pEnv-&gt;GetStaticMethodID(classID, methodName, paramCode);
          
if (! methodID)
          
{
              
LOGD(&quot;Failed to find static method id of %s&quot;, methodName);
              
break;
          
}

methodinfo.classID = classID;
          
methodinfo.env = pEnv;
          
methodinfo.methodID = methodID;

bRet = true;
      
} while (0);

return bRet;
  
}

void callback(JavaVM\* jvm, const char\* value){
      
JniMethodInfo methodInfo;
      
if (! getStaticMethodInfo(jvm, methodInfo, &quot;com/jeidee/glooxforandroid/TestClient&quot;, &quot;testCallback&quot;, &quot;(Ljava/lang/String;)V&quot;))
      
{
          
return;
      
}

jstring stringArg = methodInfo.env-&gt;NewStringUTF(value);
      
methodInfo.env-&gt;CallStaticVoidMethod(methodInfo.classID, methodInfo.methodID, stringArg);
      
methodInfo.env-&gt;DeleteLocalRef(stringArg);
      
methodInfo.env-&gt;DeleteLocalRef(methodInfo.classID);
  
}

&amp;#8230;

callback(m_jvm, &quot;call testCallback()&quot;);

</code></pre>

<p>m_jvm은 JavaVM의 인스턴스이며 jni 로드시 다음과 같이 미리 구해놓을 수 있다.</p>

<pre><code class="language-cpp">  
static JavaVM* g_JVM;

jint JNI_OnLoad(JavaVM \*jvm, void \*reserved)
  
{
      
LOGD(&quot;JNI_OnLoad&quot;);
      
g_JVM = jvm;

JNIEnv* env;
      
if (jvm-&gt;GetEnv((void **)&amp;env, JNI\_VERSION\_1\_4) != JNI\_OK) {
          
LOGD(&quot;GETENVFAILEDONLOAD&quot;);
          
return -1;
      
}
      
return JNI\_VERSION\_1_4;
  
}

JNIEXPORT void JNICALL Java\_com\_jeidee\_glooxforandroid\_NativeCall_callbackTest (JNIEnv *env, jobject obj) {

&amp;#8230;

</code></pre>

<p>필요할 경우 콜백함수측의 java 클래스를 싱글턴으로 구현해 놓고 사용하고 Handler를 사용해 ui 쓰레드와 통신하면 된다.</p>

<h2 id="참고">참고</h2>

<ul>
<li><a href="http://blog.daum.net/_blog/BlogTypeView.do?blogid=0RBJ8&amp;articleno=8&amp;_bloghome_menu=recenttext">JNI에서 콜백함수 구현</a></li>
<li><a href="http://stackoverflow.com/questions/13377168/how-to-create-callbacks-between-android-code-and-native-code">How to create callbacks between android code and native code?</a></li>
</ul>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="https://jeidee.github.io"></a></h4>
  
  <p>Read <a href="https://jeidee.github.io">more posts</a> by this author.</p>
  
  <div class="author-meta">
    
    
  </div>
</section>



    
    <section class="share">
      <h4>Share this posts</h4>
      <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=android%20ndk%2c%20native%20c%2fc%2b%2b%20%ec%bd%94%eb%93%9c%ec%97%90%ec%84%9c%20java%20%ec%bd%94%eb%93%9c%20%ed%98%b8%ec%b6%9c&amp;url=https%3a%2f%2fjeidee.github.io%2f2015%2f04%2f22%2fandroid-ndk-native-cc-ecbd94eb939cec9790ec849c-java-ecbd94eb939c-ed98b8ecb69c%2f"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
      </a>
      <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjeidee.github.io%2f2015%2f04%2f22%2fandroid-ndk-native-cc-ecbd94eb939cec9790ec849c-java-ecbd94eb939c-ed98b8ecb69c%2f"
          onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <span class="hidden">Facebook</span>
      </a>
      <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fjeidee.github.io%2f2015%2f04%2f22%2fandroid-ndk-native-cc-ecbd94eb939cec9790ec849c-java-ecbd94eb939c-ed98b8ecb69c%2f"
         onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
          <span class="hidden">Google+</span>
      </a>
    </section>
    

    
    
    

  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Erlang &amp; Go</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/index.js"></script>

</body>
</html>

