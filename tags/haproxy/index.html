<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Haproxy &middot;  Erlang &amp; Go" />
  	<meta property="og:site_name" content="Erlang &amp; Go" />
  	<meta property="og:url" content="https://jeidee.github.io/tags/haproxy/" />
    
    
    <meta property="og:type" content="website" />
    

  <title>
     Haproxy &middot;  Erlang &amp; Go
  </title>

    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://jeidee.github.ioimages/favicon.ico">
	  <link rel="apple-touch-icon" href="https://jeidee.github.ioimages/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://jeidee.github.iocss/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://jeidee.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="Erlang &amp; Go" />
      
      
        <link href="https://jeidee.github.io/tags/haproxy/index.xml" rel="alternate" type="application/rss+xml" title="Haproxy &middot; Erlang &amp; Go" />
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="https://jeidee.github.io/tags/haproxy/" />

    
<div id="particles-js"></div>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://jeidee.github.iojs/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">




	<header class="main-header tag-head no-cover">

    <nav class="main-nav overlay clearfix">
      
      
        
          <a class="menu-button icon-feed" href="https://jeidee.github.io/tags/haproxy/index.xml">&nbsp;&nbsp;Subscribe</a>
        
      
    </nav>
    <div class="vertical">

        <div class="main-header-content inner">
            <h1 class="page-title">

              <a class="btn-bootstrap-2" href="#content">Erlang &amp; Go</a>
          </h1>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">
    

	<div class="extra-pagination inner">
    <nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

	</div>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/02/09/ha-proxyeba5bc-ec82acec9aa9ed95b4ec849c-l7-switch-eab5acec84b1/">HA proxy를 사용해서 L7 switch 구성</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="다음과-같이-ha-proxy를-구성하고-싶다고-가정하자">다음과 같이 HA Proxy를 구성하고 싶다고 가정하자.</h2>

<ul>
<li>A 서버 : 웹서버

<ul>
<li><a href="http://192.168.56.101:3000/">http://192.168.56.101:3000/</a> : 홈</li>
<li><a href="http://192.168.56.101:3000/admin">http://192.168.56.101:3000/admin</a> : 관리 &#8230;</li>
</ul></li>
<li>B 서버 : RESTful API 서버

<ul>
<li><a href="http://192.168.56.102:5281/api">http://192.168.56.102:5281/api</a></li>
</ul></li>
<li>C 서버 : HA Proxy 서버

<ul>
<li><a href="https://192.168.56.103/">https://192.168.56.103/</a> =&gt; <a href="http://192.168.56.101:3000/">http://192.168.56.101:3000/</a></li>
<li><a href="https://192.168.56.103/admin">https://192.168.56.103/admin</a> =&gt; <a href="http://192.168.56.101:3000/admin">http://192.168.56.101:3000/admin</a></li>
<li><a href="https://192.168.56.103/api">https://192.168.56.103/api</a> =&gt; <a href="http://192.168.56.102:5281/api">http://192.168.56.102:5281/api</a></li>
</ul></li>
</ul>

<p>네트워크 토폴로지는 다음과 같다.</p>

<pre><code>      
+&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+ https +&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8211;+
      
| Client | &amp;#8212;&amp;#8212;&gt;| HA Proxy |
      
| | | 192.168.56.103 |
      
+&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+ +&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8211;+
                                      
| http
                                      
V
                            
+&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8211;+
                    
+&amp;#8212;&amp;#8212;-| fire wall |
                    
| +&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8211;+
                    
| | http
                    
| V
                    
| +&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+
                    
| | 192.168.56.101:3000 |
                    
| | /, /admin, /doc, &amp;#8230; |
                    
| +&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+
                    
|
                    
V
      
+&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+
      
| 192.168.56.102:5281/api |
      
+&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;+
  
</code></pre>

<h2 id="ha-proxy-설정-시나리오는-다음과-같다">HA Proxy 설정 시나리오는 다음과 같다.</h2>

<ul>
<li>192.168.56.103 서버에 HA Proxy를 설치한다.</li>
<li>frontend 구성에 https를 위한 ssl 설정을 하고(SSL Key 필요),</li>
<li>/api url을 제외한 기본 백엔드는 192.168.56.101:3000 서버를 지정하고</li>
<li>/api url의 경우 192.168.56.102:5281 서버를 지정하도록 한다.</li>
</ul>

<p>1) HA Proxy 설치</p>

<pre><code>      
$ sudo apt-get install haproxy
  
</code></pre>

<p>2) 설정</p>

<pre><code>      
$ sudo vi /etc/haproxy/haproxy.cfg
  
</code></pre>

<p>haproxy.cfg의 뒷부분에 다음을 추가하도록 한다.</p>

<pre><code>      
frontend www-https
        
bind *:443 ssl crt /home/gss.dev/server/bin/etc/ejabberd/server.pem
        
mode http
        
option httpclose
        
option forwardfor
        
reqadd X-Forwarded-Proto: https
        
acl url\_api path\_beg /api
        
use\_backend www-api if url\_api
        
default_backend www-backend

backend www-backend
        
mode http
        
server www-1 192.168.56.101:3000 check

backend www-api
        
mode http
        
server apidoc 192.168.56.102:5281 check
  
</code></pre>

<p>주의할 것은 ssl 설정을 HA Proxy서버에서 한다는 것이다. 백엔드 서버는 http로 구성해야 하며 https로 구성할 경우 Bad Gateway가 떨어진다.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-haproxy-as-a-layer-7-load-balancer-for-wordpress-and-nginx-on-ubuntu-14-04">How To Use HAProxy As A Layer 7 Load Balancer For WordPress and Nginx On Ubuntu 14.04</a></li>
<li><a href="http://seanmcgary.com/posts/using-sslhttps-with-haproxy">Using SSL/HTTPS with HAProxy</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/haproxy/">#haproxy</a>,
            
        
        <time class="post-date" datetime="2015-02-09T00:00:00Z">
            9 Feb 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/02/04/ha-proxy-ec84a4eca095/">HA Proxy 설정</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<p>우분투에서 HA Proxy 설정하는 방법을 알아보자.</p>

<h2 id="ha-proxy-설치">HA Proxy 설치</h2>

<p>다음과 같이 1.5.x 버전을 설치한다.</p>

<pre><code>      
$ sudo add-apt-repository ppa:vbernat/haproxy-1.5
      
$ sudo apt-get update
      
$ sudo apt-get install haproxy
  
</code></pre>

<h2 id="ha-proxy-설정">HA Proxy 설정</h2>

<p>HA Proxy를 위와 같이 설치하면 설정파일은 다음 위치에서 찾을 수 있다.</p>

<pre><code>      
/etc/haproxy/haproxy.cfg
  
</code></pre>

<p>기본 설정은 다음과 같이 두 영역으로 구분된다.</p>

<ul>
<li>global: process 전역 매개변수</li>
<li>proxies: defaults, listen, frontend, backend 섹션으로 구성</li>
</ul>

<p>이 중에서 listen 영역은 TCP 프록시에서만 사용하며 frontend와 backend를 모두 설정할 수 있다.</p>

<h3 id="global-설정">global 설정</h3>

<p>최대 연결수를 설정하고자 한다면 다음과 같이 global 섹션에 설정값을 입력한다.</p>

<pre><code>      
maxconn 2048
  
</code></pre>

<h3 id="listen-영역">listen 영역</h3>

<pre><code>      
listen tcp-in
          
bind *:443
          
log global
          
mode tcp
          
option tcplog
          
server server1 192.168.100.1:7443
  
</code></pre>

<p>위의 설정을 풀어보면 다음과 같다.</p>

<ul>
<li>haproxy가 실행되는 서버의 모든 IP에 443 포트로 들어오는 tcp 연결을</li>
<li>192.168.100.1서버의 7443 포트에 연결한다.</li>
</ul>

<h3 id="frontend와-backend">frontend와 backend</h3>

<p>http나 https 프록시 서버를 설정하기 위해서는 frontend와 backend 영역을 설정해야 한다.</p>

<p>frontend에 ssl 과 cert파일을 등록해 https를 구성할 수 있고 load-balancing을 위한 구성도 가능하다.</p>

<p>자세한 정보는 참조링크를 참고하면 된다.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-implement-ssl-termination-with-haproxy-on-ubuntu-14-04">How to implement SSL termination with HAProxy on Ubuntu 14.04</a></li>
<li><a href="http://arisu1000.tistory.com/27739">HAProxy 설정 및 실행</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/haproxy/">#haproxy</a>,
            
        
        <time class="post-date" datetime="2015-02-04T00:00:00Z">
            4 Feb 2015
        </time>
    </footer>
</article>

	

	<nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Erlang &amp; Go</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/index.js"></script>

</body>
</html>

