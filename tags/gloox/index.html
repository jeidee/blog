<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Gloox &middot;  Erlang &amp; Go" />
  	<meta property="og:site_name" content="Erlang &amp; Go" />
  	<meta property="og:url" content="https://jeidee.github.io/tags/gloox/" />
    
    
    <meta property="og:type" content="website" />
    

  <title>
     Gloox &middot;  Erlang &amp; Go
  </title>

    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://jeidee.github.ioimages/favicon.ico">
	  <link rel="apple-touch-icon" href="https://jeidee.github.ioimages/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://jeidee.github.iocss/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://jeidee.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="Erlang &amp; Go" />
      
      
        <link href="https://jeidee.github.io/tags/gloox/index.xml" rel="alternate" type="application/rss+xml" title="Gloox &middot; Erlang &amp; Go" />
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="https://jeidee.github.io/tags/gloox/" />

    
<div id="particles-js"></div>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://jeidee.github.iojs/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">




	<header class="main-header tag-head no-cover">

    <nav class="main-nav overlay clearfix">
      
      
        
          <a class="menu-button icon-feed" href="https://jeidee.github.io/tags/gloox/index.xml">&nbsp;&nbsp;Subscribe</a>
        
      
    </nav>
    <div class="vertical">

        <div class="main-header-content inner">
            <h1 class="page-title">

              <a class="btn-bootstrap-2" href="#content">Erlang &amp; Go</a>
          </h1>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">
    

	<div class="extra-pagination inner">
    <nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

	</div>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/06/02/gloox-xmppping/">gloox xmppPing</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<p>gloox의 경우 tcp 연결이 비정상적으로 종료되었을 때 disconnect를 감지할 수 없는 경우가 있다.</p>

<p>이럴 경우를 대비해 xmpp 서버에 주기적으로 ping을 보내고 pong을 수신해서 연결 상태를 관리하는 것이 좋다.</p>

<pre><code class="language-cpp">      
class MsgClient : public MessageSessionHandler
      
, &amp;#8230;
      
, EventHandler
      
{
      
private:
          
int m_heartBeat;
      
};

void MsgClient::heartBeat() {
          
m\_client-&gt;xmppPing(m\_client-&gt;jid(), this);
          
if (++m_heartBeat &gt; 3) {
              
LOGD(&quot;허트비트 무응답 초과로 연결 종료!&quot;);
              
m_client-&gt;disconnect();
          
}
      
}

void MsgClient::handleEvent(const Event&amp; event)
      
{
          
switch (event.eventType())
          
{
              
case Event::PingPing:
                  
LOGD(&quot;PingPing&quot;);
                  
break;
              
case Event::PingPong:
                  
LOGD(&quot;PingPong&quot;);
                  
&amp;#8211;m_heartBeat;
                  
break;
              
case Event::PingError:
                  
LOGE(&quot;PingError&quot;);
                  
break;
              
default:
                  
break;
          
}
          
return;
      
}

// ConnectionListener
      
void MsgClient::onConnect() {
          
LOGD(&quot;connected!!!&quot;);

m_heartBeat = 0;
  
</code></pre>

<p>pingpong 이벤트를 수신하기 위해서 EventHandler 인터페이스를 구현해야하고 onConnect()가 콜백될 때 m_heartBeat 값을 초기화해야 한다.</p>

<h2 id="출처">출처</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/3543294/c-gloox-how-to-check-when-connection-is-down">C++ / Gloox: how to check when connection is down?</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/gloox/">#gloox</a>,
            
        
        <time class="post-date" datetime="2015-06-02T00:00:00Z">
            2 Jun 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/04/21/gloox-for-android/">gloox for android</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<p>gloox를 android에서 사용하기 위한 과정을 살펴보자.</p>

<h2 id="사전-준비-작업">사전 준비 작업</h2>

<p>다음과 같은 환경이 구축되어 있다고 가정한다.</p>

<ul>
<li>개발 환경 : Mac OS X Yosemite 10.10.3</li>
<li>Android Studio : 1.1.0

<ul>
<li>Android SDK 경로는 ~/Android/sdk로 변경</li>
</ul></li>
<li>NDK

<ul>
<li>~/Android/ndk에 복사하고 path 지정</li>
</ul></li>
</ul>

<h2 id="android-studio에-ndk-설정">Android Studio에 ndk 설정</h2>

<p>Preference &gt; External Tools에서 + 버튼을 클릭해 javah, ndk-build, ndk-build clean 도구를 추가한다.</p>

<p>1) javah</p>

<p><img src="http://localhost:8888/wordpress/wp-content/uploads/2015/04/ec8aa4ed81aceba6b0ec83b7-2015-04-21-ec98a4eca084-11-14-17.png" alt="javah_설정" /></p>

<p>2) ndk-build</p>

<p><img src="http://localhost:8888/wordpress/wp-content/uploads/2015/04/ec8aa4ed81aceba6b0ec83b7-2015-04-21-ec98a4eca084-11-15-40.png" alt="ndk-build" /></p>

<p>3) ndk-build clean</p>

<p><img src="http://localhost:8888/wordpress/wp-content/uploads/2015/04/ec8aa4ed81aceba6b0ec83b7-2015-04-21-ec98a4eca084-11-16-40.png" alt="ndk-build clean" /></p>

<h2 id="android-project-생성후-ndk-테스트">Android Project 생성후 NDK 테스트</h2>

<p>1) GlooxForAndroid 이름을 갖는 Android Project를 생성한다.</p>

<p>2) app/src/main/res/layout/activity_main.xml을 다음과 같이 수정한다.</p>

<pre><code>  
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
      
xmlns:tools=&quot;http://schemas.android.com/tools&quot; android:layout\_width=&quot;match\_parent&quot;
      
android:layout\_height=&quot;match\_parent&quot; android:paddingLeft=&quot;@dimen/activity\_horizontal\_margin&quot;
      
android:paddingRight=&quot;@dimen/activity\_horizontal\_margin&quot;
      
android:paddingTop=&quot;@dimen/activity\_vertical\_margin&quot;
      
android:paddingBottom=&quot;@dimen/activity\_vertical\_margin&quot; tools:context=&quot;.MainActivity&quot;&gt;

&lt;Button
          
android:id=&quot;@+id/callBtn&quot;
          
android:layout\_width=&quot;wrap\_content&quot;
          
android:layout\_height=&quot;wrap\_content&quot;
          
android:text=&quot;Call JNI&quot; /&gt;

&lt;TextView
          
android:id=&quot;@+id/textVal&quot;
          
android:layout\_width=&quot;wrap\_content&quot;
          
android:layout\_height=&quot;wrap\_content&quot;
          
android:textSize=&quot;15pt&quot; /&gt;
  
&lt;/LinearLayout&gt;
  
</code></pre>

<p>Button 하나와 TextView 하나를 추가했다.</p>

<p>3) MainActivity.java를 다음과 같이 수정한다.</p>

<pre><code class="language-java">  
public class MainActivity extends ActionBarActivity {

private Button btn_;
      
private TextView textView_;

@Override
      
protected void onCreate(Bundle savedInstanceState) {
          
super.onCreate(savedInstanceState);
          
setContentView(R.layout.activity_main);

btn_ = (Button) findViewById(R.id.callBtn);
          
textView_ = (TextView) findViewById(R.id.textVal);

btn_.setOnClickListener(new View.OnClickListener() {
              
@Override
              
public void onClick(View v) {
                  
NativeCall nativeCall = new NativeCall();
                  
int ret = nativeCall.add(10, 20);
                  
String retStr = nativeCall.stringFromJNI();
                  
textView_.setText(retStr);
              
}
          
});
      
}
  
</code></pre>

<p>btn_을 클릭했을 때 NativeCall클래스의 함수를 호출한 결과를 textView_에 출력한다.</p>

<p>NativeCall클래스는 jni를 사용해 c/c++ 코드를 호출하게 된다.</p>

<p>4) NativeCall.java 클래스를 생성한다.</p>

<pre><code class="language-java">  
public class NativeCall {
      
static {
          
System.loadLibrary(&quot;my_lib&quot;);
      
}

public native int add(int i, int j);

public native String stringFromJNI();
  
}
  
</code></pre>

<p>Project 탐색기의 NativeCalll.java 클래스에서 마우스 우측 버튼으로 팝업메뉴를 출력한 후 NDK&gt;javah를 선택하면,</p>

<p>jni 디렉토리에 com_example_jeidee_glooxforandroid_NativerCall.h파일이 생성된다.</p>

<p>5) my_lib.cpp 파일을 생성한다.</p>

<pre><code class="language-cpp">  
#include &quot;com\_example\_jeidee\_ndktest\_NativeCall.h&quot;

JNIEXPORT jint JNICALL Java\_com\_jeidee\_glooxforandroid\_NativeCall_add
    
(JNIEnv *, jobject, jint i, jint j) {
      
return i + j;
    
}

JNIEXPORT jstring JNICALL Java\_com\_jeidee\_glooxforandroid\_NativeCall_stringFromJNI
    
(JNIEnv *env, jobject) {
      
return env-&gt;NewStringUTF(&quot;Hello JNI!!!!!&quot;);
    
}

</code></pre>

<p>6) ndk-build</p>

<p>app/src/build.gradle 파일을 열고 다음과 같이 ndk와 sourceSets.main 항목을 입력한다.</p>

<pre><code class="language-json">  
android {
      
compileSdkVersion 22
      
buildToolsVersion &quot;21.1.2&quot;

defaultConfig {
          
applicationId &quot;com.jeidee.glooxforandroid&quot;
          
minSdkVersion 15
          
targetSdkVersion 22
          
versionCode 1
          
versionName &quot;1.0&quot;

ndk {
              
moduleName &quot;my_lib&quot;
          
}

sourceSets.main {
              
jniLibs.srcDir 'src/main/libs'
              
jni.srcDirs = [] //important!!!! disable automatic ndk-build call
          
}
      
}

</code></pre>

<p>Project 탐색기의 NativeCall.java 클래스에서 마우스 우측 버튼으로 팝업메뉴를 출력한 후 NDK ndk-build를 선택하면,</p>

<p>빌드가 완료되고 src/main/libs/armeabi 디렉토리에 libmy_lib.so 공유 라이브러리 파일이 생성된다.</p>

<p>7) 빌드 후 테스트</p>

<p>안드로이드 디바이스를 연결후 Run &#8216;app&#8217;을 실행한다.</p>

<h2 id="openssl-for-android-빌드">openssl for android 빌드</h2>

<p>gloox는 openssl 라이브러리를 사용하기 때문에 openssl 소스를 빌드해 라이브러리를 얻어야 한다.</p>

<p>android를 위해 누군가 <a href="https://github.com/eighthave/openssl-android">github에 ndk-build를 위한 구성과 소스</a>를 올려 놓았으므로 다운로드 받아 사용하도록 한다.</p>

<p>git clone한 후 해당 디렉토리에서 ndk-build를 수행하면 된다.</p>

<p>성공적으로 빌드가 완료되면 libs/armeabi 디렉토리에 libssl.so와 libcrypto.so 파일이 생성된다.</p>

<p>해당 파일을 Android Project의 src/main/jni 하위에 libs 디렉토리를 생성하고 이 곳에 복사해 넣는다.</p>

<p>src/main/jni 하위에 openssl 디렉토리를 생성하고,</p>

<p>openssl의 include와 crypto 디렉토리를 복사해 넣는다.</p>

<h2 id="gloox-for-xcode-에서-소스-파일-복사해-오기">gloox for xcode 에서 소스 파일 복사해 오기</h2>

<p>이 글을 작성하는 현시점에서 gloox는 1.0.13버전이 최신버전이다.</p>

<p>해당 버전의 소스를 받아 ./configure &#8211;host=arm-linux를 수행한 후 소스파일을 복사해 사용해도 되지만,</p>

<p>[gloox for xcode]() 오픈소스를 받아 해당 프로젝트에 포함된 gloox 파일을 사용하도록 한다.</p>

<p>git clone한 후 Utils/gloox 디렉토리를 app/src/main/jni 디렉토리에 복사해 넣는다.</p>

<h2 id="android-mk-수정">Android.mk 수정</h2>

<p>1) openssl for android 빌드 결과물인 libcrypto와 libssl 라이브러리를 다음과 같이 Android.mk파일의 맨 위해 추가한다.</p>

<pre><code>  
LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_MODULE := libcrypto

LOCAL\_SRC\_FILES := libs/libcrypto.so

include $(PREBUILT\_SHARED\_LIBRARY)

include $(CLEAR_VARS)

LOCAL_MODULE := libssl

LOCAL\_SRC\_FILES := libs/libssl.so

include $(PREBUILT\_SHARED\_LIBRARY)
  
</code></pre>

<p>2) gloox의 소스파일을 다음과 같이 추가한다.</p>

<pre><code>  
LOCAL\_SRC\_FILES :=
                      
my_lib.cpp
                      
gloox/adhoc.cpp
                      
gloox/amp.cpp
                      
gloox/annotations.cpp
                      
gloox/attention.cpp
                      
gloox/base64.cpp
                      
gloox/bookmarkstorage.cpp
                      
gloox/capabilities.cpp
                      
gloox/chatstate.cpp
                      
gloox/chatstatefilter.cpp
                      
gloox/client.cpp
                      
gloox/clientbase.cpp
                      
gloox/component.cpp
                      
gloox/compressiondefault.cpp
                      
gloox/compressionzlib.cpp
                      
gloox/connectionbosh.cpp
                      
gloox/connectionhttpproxy.cpp
                      
gloox/connectionsocks5proxy.cpp
                      
gloox/connectiontcpbase.cpp
                      
gloox/connectiontcpclient.cpp
                      
gloox/connectiontcpserver.cpp
                      
gloox/connectiontls.cpp
                      
gloox/connectiontlsserver.cpp
                      
gloox/dataform.cpp
                      
gloox/dataformfield.cpp
                      
gloox/dataformfieldcontainer.cpp
                      
gloox/dataformitem.cpp
                      
gloox/dataformreported.cpp
                      
gloox/delayeddelivery.cpp
                      
gloox/disco.cpp
                      
gloox/dns.cpp
                      
gloox/error.cpp
                      
gloox/eventdispatcher.cpp
                      
gloox/featureneg.cpp
                      
gloox/flexoff.cpp
                      
gloox/gloox.cpp
                      
gloox/gpgencrypted.cpp
                      
gloox/gpgsigned.cpp
                      
gloox/inbandbytestream.cpp
                      
gloox/instantmucroom.cpp
                      
gloox/iq.cpp
                      
gloox/jid.cpp
                      
gloox/lastactivity.cpp
                      
gloox/logsink.cpp
                      
gloox/md5.cpp
                      
gloox/message.cpp
                      
gloox/messageevent.cpp
                      
gloox/messageeventfilter.cpp
                      
gloox/messagefilter.cpp
                      
gloox/messagesession.cpp
                      
gloox/mucmessagesession.cpp
                      
gloox/mucroom.cpp
                      
gloox/mutex.cpp
                      
gloox/nickname.cpp
                      
gloox/nonsaslauth.cpp
                      
gloox/oob.cpp
                      
gloox/parser.cpp
                      
gloox/prep.cpp
                      
gloox/presence.cpp
                      
gloox/privacyitem.cpp
                      
gloox/privacymanager.cpp
                      
gloox/privatexml.cpp
                      
gloox/pubsubevent.cpp
                      
gloox/pubsubitem.cpp
                      
gloox/pubsubmanager.cpp
                      
gloox/receipt.cpp
                      
gloox/registration.cpp
                      
gloox/rosteritem.cpp
                      
gloox/rostermanager.cpp
                      
gloox/search.cpp
                      
gloox/sha.cpp
                      
gloox/shim.cpp
                      
gloox/simanager.cpp
                      
gloox/siprofileft.cpp
                      
gloox/socks5bytestream.cpp
                      
gloox/socks5bytestreammanager.cpp
                      
gloox/socks5bytestreamserver.cpp
                      
gloox/softwareversion.cpp
                      
gloox/stanza.cpp
                      
gloox/stanzaextensionfactory.cpp
                      
gloox/subscription.cpp
                      
gloox/tag.cpp
                      
gloox/tlsdefault.cpp
                      
gloox/tlsgnutlsbase.cpp
                      
gloox/tlsgnutlsclient.cpp
                      
gloox/tlsgnutlsclientanon.cpp
                      
gloox/tlsgnutlsserveranon.cpp
                      
gloox/tlsopensslbase.cpp
                      
gloox/tlsopensslclient.cpp
                      
gloox/tlsopensslserver.cpp
                      
gloox/tlsschannel.cpp
                      
gloox/uniquemucroom.cpp
                      
gloox/util.cpp
                      
gloox/vcard.cpp
                      
gloox/vcardmanager.cpp
                      
gloox/vcardupdate.cpp
                      
gloox/xhtmlim.cpp
  
</code></pre>

<p>3) openssl의 header files 경로를 다음과 같이 추가한다.</p>

<pre><code>  
LOCAL\_C\_INCLUDES := $(LOCAL_PATH)/openssl/include/
  
LOCAL\_C\_INCLUDES += $(LOCAL_PATH)/openssl/
  
</code></pre>

<p>4) openssl shared library와 zlib를 링크하기 위해 다음과 같이 추가하고 마무리한다.</p>

<pre><code>  
LOCAL\_SHARED\_LIBRARIES := libssl libcrypto

LOCAL_LDLIBS := -llog
  
LOCAL_LDLIBS += -lz

include $(BUILD\_SHARED\_LIBRARY)
  
</code></pre>

<p>LOCAL_LDLIBS += -lz 설정을 통해 zlib이 링크된다.</p>

<h2 id="application-mk-생성">Application.mk 생성</h2>

<p>c++ stl library 사용을 위해 jni 디렉토리 밑에 Application.mk파일을 생성하고 다음과 같이 입력한다.</p>

<pre><code>  
APP\_STL := c++\_static
  
</code></pre>

<h2 id="ndk-build">ndk-build</h2>

<p>1) error: &#8216;atoi&#8217; was not declared in this scope</p>

<p>.cpp 상단에 #include 를 추가해 준다.</p>

<p>2) RSA_generate_key() deprecate error</p>

<p>NativeCall.java 파일을 ndk-build하면 tlsopensslserver.cpp 컴파일 도중 에러가 발생하는데, RSA_generate_key()가 deprecate 되었기 때문에 다음 소스 코드를 추가해야 한다.</p>

<p>(참고 : <a href="http://aucd29.tistory.com/m/post/1101">with openssl porting guide</a>)</p>

<pre><code class="language-c">  
RSA *RSA\_generate\_key(int bits, unsigned long e_value,
           
void (\*callback)(int,int,void \*), void *cb_arg)
      
{
      
BN_GENCB cb;
      
int i;
      
RSA *rsa = RSA_new();
      
BIGNUM *e = BN_new();

if(!rsa || !e) goto err;

/* The problem is when building with 8, 16, or 32 BN_ULONG,
       
\* unsigned long can be larger \*/
      
for (i=0; i&lt;(int)sizeof(unsigned long)*8; i++)
          
{
          
if (e_value &amp; (1UL&lt;&lt;i))
              
if (BN\_set\_bit(e,i) == 0)
                  
goto err;
          
}

BN\_GENCB\_set\_old(&amp;cb, callback, cb\_arg);

if(RSA\_generate\_key_ex(rsa, bits, e, &amp;cb)) {
          
BN_free(e);
          
return rsa;
      
}
  
err:
      
if(e) BN_free(e);
      
if(rsa) RSA_free(rsa);
      
return 0;
      
}
  
</code></pre>

<h2 id="전체-프로젝트-다운로드">전체 프로젝트 다운로드</h2>

<p>github에 올려 놓았다.</p>

<p><a href="https://github.com/jeidee/GlooxForAndroid">https://github.com/jeidee/GlooxForAndroid</a></p>

<h2 id="참고">참고</h2>

<ul>
<li><a href="https://github.com/eighthave/openssl-android">openssl-android</a></li>
<li><a href="http://herry.sinaapp.com/?p=31">gloox for android</a></li>
<li><a href="http://blog.y3xz.com/blog/2012/10/07/setting-up-an-arm-eabi-toolchain-on-mac-os-x">Setting Up an ARM EABI Toolchain on Mac OS X</a></li>
<li><a href="http://asos.tistory.com/13">Android에서 OpenSSL의 암호 알고리즘 사용하기 &#8211; 1편</a></li>
<li><a href="http://choizak.tistory.com/63">Android Project 에서 OpenSSL 사용하기</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/gloox/">#gloox</a>,
            
                <a href="https://jeidee.github.iotags/ndk/">#ndk</a>,
            
                <a href="https://jeidee.github.iotags/openssl/">#openssl</a>,
            
        
        <time class="post-date" datetime="2015-04-21T00:00:00Z">
            21 Apr 2015
        </time>
    </footer>
</article>

	

	<nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Erlang &amp; Go</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/index.js"></script>

</body>
</html>

