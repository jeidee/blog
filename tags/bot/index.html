<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Bot &middot;  Erlang &amp; Go" />
  	<meta property="og:site_name" content="Erlang &amp; Go" />
  	<meta property="og:url" content="https://jeidee.github.io/tags/bot/" />
    
    
    <meta property="og:type" content="website" />
    

  <title>
     Bot &middot;  Erlang &amp; Go
  </title>

    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://jeidee.github.ioimages/favicon.ico">
	  <link rel="apple-touch-icon" href="https://jeidee.github.ioimages/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://jeidee.github.iocss/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://jeidee.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="Erlang &amp; Go" />
      
      
        <link href="https://jeidee.github.io/tags/bot/index.xml" rel="alternate" type="application/rss+xml" title="Bot &middot; Erlang &amp; Go" />
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="https://jeidee.github.io/tags/bot/" />

    
<div id="particles-js"></div>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://jeidee.github.iojs/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">




	<header class="main-header tag-head no-cover">

    <nav class="main-nav overlay clearfix">
      
      
        
          <a class="menu-button icon-feed" href="https://jeidee.github.io/tags/bot/index.xml">&nbsp;&nbsp;Subscribe</a>
        
      
    </nav>
    <div class="vertical">

        <div class="main-header-content inner">
            <h1 class="page-title">

              <a class="btn-bootstrap-2" href="#content">Erlang &amp; Go</a>
          </h1>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">
    

	<div class="extra-pagination inner">
    <nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

	</div>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/03/04/ejabberd-external-component-ec97b0eb8f99/">ejabberd external component 연동</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="xmpp-component-개요">xmpp component 개요</h2>

<p>xmpp에는 external component 관련 공식 프로토콜인 <a href="http://xmpp.org/extensions/xep-0114.html">Jabber Component Protocol</a>이 있다.</p>

<p>Jabber Component Protocol은 외부 컴포넌트를 XMPP서버와 연동하기 위한 규약을 제안하는데 크게 accept와 connect에 대한 XML 스키마와 handshake flow를 명세하고 있다.</p>

<p>xmpp의 external component는 프로토콜만 준수한다면 어떤 언어를 사용해서도 구현할 수 있다. 3rd-party 컴포넌트를 ejabberd와 연동하는 방법은 <a href="https://www.ejabberd.im/tutorials-transports">Install Components and Transports to othe networks</a> 문서를 참고하도록 한다.</p>

<h2 id="echo-bot-component-만들어서-연동해-보기">echo-bot component 만들어서 연동해 보기</h2>

<p>node-xmpp-component 모듈을 사용해서 간단한 에코봇을 컴포넌트로 만들어 ejabberd와 연동해 보도록 하자.</p>

<p>우선 다음과 같이 node-xmpp-component와 node-xmpp-core를 설치한다.</p>

<pre><code>  
$ npm install node-xmpp-component
  
$ npm install node-xmpp-core
  
</code></pre>

<p>다음과 같이 에코 봇을 작성한다.</p>

<pre><code class="language-javascript">  
var Component = require('node-xmpp-component')
      
, argv = process.argv
      
, ltx = require('node-xmpp-core').ltx

if (argv.length &lt; 6) {
      
console.error('Usage: node echo_bot.js &lt;my-jid&gt; &lt;my-password&gt; ' +
      
'&lt;server&gt; &lt;port&gt;')
      
process.exit(1)
  
}

var component = new Component({
      
jid: argv[2],
      
password: argv[3],
      
host: argv[4],
      
port: Number(argv[5]),
      
reconnect: true
  
})

component.on('online', function() {
      
console.log('Component is online')

component.on('stanza', function(stanza) {
          
console.log('Received stanza: ', stanza)
          
if (stanza.is('message') &amp;&amp; stanza.attrs.type === 'chat') {
              
var i = parseInt(stanza.getChildText('body'))
              
var reply = new ltx.Element('message', { to: stanza.attrs.from, from: stanza.attrs.to, type: 'chat' })
              
reply.c('body').t(stanza)
              
component.send(reply)
          
}
      
})
  
})

component.on('offline', function () {
      
console.log('Component is offline')
  
})

component.on('connect', function () {
      
console.log('Component is connected')
  
})

component.on('reconnect', function () {
      
console.log('Component reconnects …')
  
})

component.on('disconnect', function (e) {
      
console.log('Component is disconnected', e)
  
})

component.on('error', function(e) {
      
console.error(e)
      
process.exit(1)
  
})

process.on('exit', function () {
      
component.end()
  
})
  
</code></pre>

<p>ejabberd.yml을 다음과 같이 수정한다.</p>

<pre><code>  
##
    
\## ejabberd_service: Interact with external components (transports, &amp;#8230;)
    
##
    
&amp;#8211;
       
port: 8888
       
module: ejabberd_service
       
access: all
       
shaper_rule: fast
       
ip: &quot;127.0.0.1&quot;
       
hosts:
         
&quot;foo.hello.world&quot;:
           
password: &quot;foo&quot;

</code></pre>

<p>ejabberd를 시작한 후 다음과 같이 컴포넌트를 시작한다.</p>

<pre><code>  
$ ejabberdctl start
  
$ node echo_bot.js foo.hello.world foo localhost 8888
  
</code></pre>

<p>정상적으로 연결이 될 경우 다음과 같은 메세지가 출력된다.</p>

<pre><code>  
Component is connected
  
Component is online
  
</code></pre>

<p>이 상태에서 XMPP 클라이언트로 접속한 후 foo.hello.world에게 메세지를 전송해 보자.</p>

<p>문제가 없을 경우 보낸 메세지가 다시 내게로 돌아오게 된다.</p>

<h2 id="활용">활용</h2>

<p>xmpp component의 활용은 다양하게 활용될 수 있다. 다른 메신저 서비스에 메세지 라우팅을 하거나, 날씨/사전/FAQ등의 봇 서비스에 활용될 수도 있다.</p>

<h2 id="참고">참고</h2>

<ul>
<li><a href="https://www.ejabberd.im/tutorials-transports">Install Components and Transports to Other Networks</a></li>
<li><a href="https://www.ejabberd.im/node/5134">Configuring Ejabberd to use an external component (with XEP-0114)</a></li>
<li><a href="http://xmpp.org/extensions/xep-0114.html">Jabber Component Protocol</a></li>
<li><a href="https://github.com/node-xmpp/node-xmpp-component">node-xmpp-component</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/bot/">#bot</a>,
            
                <a href="https://jeidee.github.iotags/component/">#component</a>,
            
        
        <time class="post-date" datetime="2015-03-04T00:00:00Z">
            4 Mar 2015
        </time>
    </footer>
</article>

	

	<nav class="pagination" role="navigation">
	
	<span class="page-number">Page 1 of 1</span>
	
</nav>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Erlang &amp; Go</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/index.js"></script>

</body>
</html>

