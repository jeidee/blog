<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Ejabberd &middot;  Erlang &amp; Go" />
  	<meta property="og:site_name" content="Erlang &amp; Go" />
  	<meta property="og:url" content="https://jeidee.github.io/categories/ejabberd/" />
    
    
    <meta property="og:type" content="website" />
    

  <title>
     Ejabberd &middot;  Erlang &amp; Go
  </title>

    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://jeidee.github.ioimages/favicon.ico">
	  <link rel="apple-touch-icon" href="https://jeidee.github.ioimages/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://jeidee.github.iocss/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://jeidee.github.ioindex.xml" rel="alternate" type="application/rss+xml" title="Erlang &amp; Go" />
      
      
        <link href="https://jeidee.github.io/categories/ejabberd/index.xml" rel="alternate" type="application/rss+xml" title="Ejabberd &middot; Erlang &amp; Go" />
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="https://jeidee.github.io/categories/ejabberd/" />

    
<div id="particles-js"></div>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://jeidee.github.iojs/particles.js"></script>   
</head>
<body class="nav-closed">

  


 <div class="site-wrapper">




	<header class="main-header tag-head no-cover">

    <nav class="main-nav overlay clearfix">
      
      
        
          <a class="menu-button icon-feed" href="https://jeidee.github.io/categories/ejabberd/index.xml">&nbsp;&nbsp;Subscribe</a>
        
      
    </nav>
    <div class="vertical">

        <div class="main-header-content inner">
            <h1 class="page-title">

              <a class="btn-bootstrap-2" href="#content">Erlang &amp; Go</a>
          </h1>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

<main id="content" class="content" role="main">
    

	<div class="extra-pagination inner">
    <nav class="pagination" role="navigation">
	
	    <a class="newer-posts" href="/categories/ejabberd/page/3/">&larr; Newer Posts</a>
	
	<span class="page-number">Page 4 of 4</span>
	
</nav>

	</div>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/01/21/ejabberd-ebb0b1ec9785eab3bc-ebb3b5ec9b90/">ejabberd 백업과 복원</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            <p>ejabberdctl의 admin 명령어를 사용해 백업과 복원을 수행할 수 있다.</p>

<p><strong>백업</strong></p>

<pre><code>      
$ ejabberdctl backup 백업파일명
  
</code></pre>

<p><strong>복원</strong></p>

<pre><code>      
$ ejabberdctl restore 백업파일명
  
</code></pre>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        on
            
                <a href="https://jeidee.github.iotags/%EB%B0%B1%EC%97%85/">#백업</a>,
            
                <a href="https://jeidee.github.iotags/%EB%B3%B5%EC%9B%90/">#복원</a>,
            
        
        <time class="post-date" datetime="2015-01-21T00:00:00Z">
            21 Jan 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/01/21/ejabberd-ec84a4ecb998ec9980-eab8b0ebb3b8-ec84a4eca095/">ejabberd 설치와 기본 설정</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="사전에-설치해야-하는-것-들">사전에 설치해야 하는 것 들</h2>

<ul>
<li>GNU Make</li>
<li>GCC</li>
<li>Libexpat 1.95 or higher</li>
<li>Erlang/OTP R15B or higher.</li>
<li>Libyaml 0.1.4 or higher</li>
<li>OpenSSL 0.9.8 or higher, for STARTTLS, SASL and SSL encryption.</li>

<li><p>Zlib 1.2.3 or higher, for Stream Compression support (XEP-01383</p>

<p>). Optional.</p></li>

<li><p>PAM library. Optional. For Pluggable Authentication Modules (PAM). See section 3.1.5.</p></li>

<li><p>GNU Iconv 1.8 or higher, for the IRC Transport (mod irc). Optional. Not needed on</p>

<p>systems with GNU Libc. See section 3.3.8.</p></li>

<li><p>ImageMagick’s Convert program. Optional. For CAPTCHA challenges. See section 3.1.9</p></li>
</ul>

<p>이 중에서 Libexpat, Erlang, Libyaml, Openssl은 꼭 설치한다.</p>

<p>모두 설치한 후 실행했는데 Libyaml과 관련해서 다음과 같은 오류가 생긴다면,</p>

<pre><code>      
[error] unable to load p1\_yaml NIF: {error,{load\_failed,&quot;Failed to load NIF library /lib/ejabberd/priv/lib/p1_yaml:
  
</code></pre>

<p>다음 문서를 참고해서 libyaml rpm을 받아 설치하면 된다.</p>

<p><a href="http://blog.sina.com.cn/s/blog_96b8a1540101esch.html">http://blog.sina.com.cn/s/blog_96b8a1540101esch.html</a></p>

<h2 id="리눅스계열-설치">리눅스계열 설치</h2>

<h3 id="설치">설치</h3>

<h4 id="openssl-설치">openssl 설치</h4>

<pre><code>      
wget ftp://ftp.openssl.org/source/openssl-1.0.0o.tar.gz
      
tar xvzf openssl-1.0.0o.tar.gz
      
cd openssl-1.0.0o
      
./config
      
sudo make &amp;&amp; sudo make install
  
</code></pre>

<h4 id="libyaml-설치">libyaml 설치</h4>

<pre><code>      
wget http://pyyaml.org/download/libyaml/yaml-0.1.6.tar.gz
      
tar xzvf yaml-0.1.6.tar.gz
      
cd yaml-0.1.6/
      
./configure
      
make
      
sudo make install
  
</code></pre>

<p>libyaml 관련 yaml.h와 library를 찾지 못한다면 다음과 같이 make 옵션을 준다.</p>

<p>(OSX에서 make할 때 libyaml을 설치했음에도 찾지 못하는 경우가 있다.)</p>

<pre><code>      
sudo make CFLAGS=&quot;-I/usr/local/include&quot; LDFLAGS=&quot;-L/usr/local/lib&quot;
  
</code></pre>

<h4 id="ejabberd-설치">ejabberd 설치</h4>

<pre><code>      
git clone git://github.com/processone/ejabberd.git ejabberd
      
cd ejabberd
      
./configure
      
make
      
make install
  
</code></pre>

<p>mysql을 사용하고자 한다면 다음과 같이 해야 한다.</p>

<p>&#8211;prefix는 설치경로</p>

<pre><code>      
./configure &amp;#8211;enable-odbc &amp;#8211;enable-mysql &amp;#8211;prefix=/services/app/ejabberd
  
</code></pre>

<p>mysql 쿼리는 다음과 같이 실행해 줍니다.</p>

<pre><code>      
cd ejabberd-14.07/sql
      
mysql -uroot -p
      
&gt; create database ejabberd;
      
&gt; grant all privileges on ejabberd.* to ejabberd@localhost identified by 'password' with grant option;
      
&gt; grant all privileges on ejabberd.* to ejabberd@127.0.0.1 identified by 'password' with grant option;
      
&gt; flush privileges;
      
&gt; use ejabberd;
      
&gt; source mysql.sql
  
</code></pre>

<h3 id="실행">실행</h3>

<pre><code>      
ejabberdctl start
      
or
      
ejabberdctl live
  
</code></pre>

<h2 id="설치후-해야하는-것들">설치후 해야하는 것들</h2>

<p>최근 버전의 ejabberd의 경우에는 설정파일을 yaml 포맷을 사용한다.</p>

<p>yaml의 경우 수정할 때 다음과 같은 사항을 유의해야 한다.</p>

<pre><code>      
key:value # 유효하지 않음
      
key: value # 유효함
  
</code></pre>

<p>둘의 차이는 콜론(:)뒤에 value를 입력할 때 공백으로 간격이 있는지 여부이다.</p>

<p>이 외에도 유의할 사항이 있으면 계속 추가하겠다.</p>

<h3 id="0-served-host-추가">0. served host 추가</h3>

<pre><code>       
76 ### ================
       
77 ### SERVED HOSTNAMES
       
78
       
79 ##
       
80 ## hosts: Domains served by ejabberd.
       
81 ## You can define one or several, for example:
       
82 ## hosts:
       
83 ## &amp;#8211; &quot;example.net&quot;
       
84 ## &amp;#8211; &quot;example.com&quot;
       
85 ## &amp;#8211; &quot;example.org&quot;
       
86 ##
       
87 hosts:
       
88 &amp;#8211; &quot;localhost&quot;
       
89 &amp;#8211; &quot;example.org&quot;
  
</code></pre>

<h3 id="admin-계정-추가">admin 계정 추가</h3>

<pre><code>      
$ ejabberdctl register admin example.org 1234
  
</code></pre>

<h3 id="acl-수정">acl 수정</h3>

<pre><code>      
$ vi /etc/ejabberd/ejabberd.yml
  
</code></pre>

<p>acl:을 검색해서 다음과 같이 수정한다.</p>

<pre><code>      
acl:
        
admin:
          
user:
            
&amp;#8211; &quot;admin&quot;: &quot;example.org&quot;
      
access:
        
configure:
          
admin: allow
  
</code></pre>

<p>만약 ip(예를 들어 192.168.101.101)나 추가 도메인이 필요하면,</p>

<p>다음과 같이 추가해 줘야 한다.</p>

<pre><code>      
###. ====================
      
###' ACCESS CONTROL LISTS
      
acl:
        
admin:
         
user:
           
&amp;#8211; &quot;admin1&quot;: &quot;192.168.101.101&quot;
  
</code></pre>

<p>mysql 설정은 다음과 같이 한다.</p>

<pre><code>      
$ vi /etc/ejabberd/ejabberd.yml

auth_method: odbc
      
\## auth_method: internal에서 변경한다.

\## MySQL server:
      
##
      
odbc_type: mysql
      
odbc_server: &quot;localhost&quot;
      
odbc_database: &quot;ejabberd&quot;
      
odbc_username: &quot;ejabberd&quot;
      
odbc_password: &quot;ejabberd&quot;
  
</code></pre>

<p><a href="https://www.ejabberd.im/Using%20ejabberd%20with%20MySQL%20native%20driver">https://www.ejabberd.im/Using%20ejabberd%20with%20MySQL%20native%20driver</a></p>

<h3 id="tls-설정">TLS 설정</h3>

<h4 id="openssl-사용해서-pem-생성">openssl 사용해서 pem 생성</h4>

<p><a href="https://www.ejabberd.im/tuto-install-ejabberd">https://www.ejabberd.im/tuto-install-ejabberd</a></p>

<h4 id="ejabberd-yml-수정">ejabberd.yml 수정</h4>

<h2 id="osx에서-설치">OSX에서 설치</h2>

<pre><code>  
export LDFLAGS=&quot;-L/usr/local/opt/openssl/lib -L/usr/local/lib -L/usr/local/opt/expat/lib&quot;
  
export CFLAGS=&quot;-I/usr/local/opt/openssl/include/ -I/usr/local/include -I/usr/local/opt/expat/include&quot;
  
export CPPFLAGS=&quot;-I/usr/local/opt/openssl/include/ -I/usr/local/include -I/usr/local/opt/expat/include&quot;
  
</code></pre>

<p>자세한 내용은 다음 문서 참조</p>

<ul>
<li><a href="https://docs.ejabberd.im/admin/guide/installation/">ejabberd installation</a></li>
</ul>

<h2 id="관리-콘솔">관리 콘솔</h2>

<p><a href="http://127.0.0.1:5280/admin">http://127.0.0.1:5280/admin</a></p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="http://www.process-one.net/docs/ejabberd/guide_en.pdf">http://www.process-one.net/docs/ejabberd/guide_en.pdf</a></li>
</ul>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        
        <time class="post-date" datetime="2015-01-21T00:00:00Z">
            21 Jan 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/01/21/ejabberd-ec99b8ebb680-ec9db8eca69d-ebaaa8eb9388/">ejabberd 외부 인증 모듈</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<h2 id="ejabberd-외부-인증-모듈">ejabberd 외부 인증 모듈</h2>

<ul>
<li><a href="https://www.ejabberd.im/files/doc/dev.html#htoc9">참고문서</a></li>
</ul>

<h3 id="개요">개요</h3>

<p>외부 인증 스크립트는 <a href="http://www.erlang.org/doc/tutorial/c_portdriver.html">erlang port driver API</a>를 따릅니다.</p>

<p>스크립트는 다음과 같은 일을 수행하는 무한 루프로 구성해야 합니다:</p>

<ul>
<li>stdin에서 AABBBBBB&#8230;.형식의 byte stream을 읽는다.

<ul>
<li>A: 데이터의 길이를 의미하는 2bytes 정수(네트워크 바이트 오더 사용)</li>
<li>B: 다음과 같은 plain 텍스트 오퍼레이션을 포함

<ul>
<li>auth:User:Server:Password(username/password 검사)</li>
<li>isuser:User:Server(유효한 user인지 검사)</li>
<li>setpass:User:Server:Password(user의 암호 설정)</li>
<li>tryregister:User:Server:Password(계정 등록 시도)</li>
<li>removeuser:User:Server(계정 삭제)</li>
<li>removeuser3:User:Server:Password(암호가 유효하면 계정 삭제)</li>
</ul></li>
</ul></li>
<li>stdout에 결과 출력: AABB

<ul>
<li>A: 다음 결과값에 대한 길이. 2bytes 정수(short)</li>
<li>B: 결과 코드(short). 1은 성공/유효, 0은 실패/유효하지 않음.</li>
</ul></li>
</ul>

<h3 id="샘플코드">샘플코드</h3>

<h4 id="python">python</h4>

<pre><code class="language-python">      
#!/usr/bin/python

import sys
      
from struct import *

def from_ejabberd():
          
input_length = sys.stdin.read(2)
          
(size,) = unpack('&gt;h', input_length)
          
return sys.stdin.read(size).split(':')

def to_ejabberd(bool):
          
answer = 0
          
if bool:
              
answer = 1
          
token = pack('&gt;hh', 2, answer)
          
sys.stdout.write(token)
          
sys.stdout.flush()

def auth(username, server, password):
          
return True

def isuser(username, server):
          
return True

def setpass(username, server, password):
          
return True

while True:
          
data = from_ejabberd()
          
success = False
          
if data[0] == &quot;auth&quot;:
              
success = auth(data[1], data[2], data[3])
          
elif data[0] == &quot;isuser&quot;:
              
success = isuser(data[1], data[2])
          
elif data[0] == &quot;setpass&quot;:
              
success = setpass(data[1], data[2], data[3])
          
to_ejabberd(success)
  
</code></pre>

<h4 id="node-js">node.js</h4>

<p>node.js용 ejabberd auth 모듈이 여럿 있습니다.</p>

<p>그 중 <a href="https://github.com/derWhity/node-ejabberd-auth">ejabberd-auth</a> 모듈은 다음과 같이 사용합니다.</p>

<h5 id="1-모듈-설치">1. 모듈 설치</h5>

<pre><code>      
npm install ejabberd-auth
  
</code></pre>

<h5 id="2-auth-js-작성">2. auth.js 작성</h5>

<pre><code class="language-javascript">      
require('ejabberd-auth').run({
          
actions: {
              
auth: function(done, userName, domain, password) {
                  
// Some auth to be done here
                  
done(true); // or done(false) if the authentification has failed
              
}
          
}
      
});
  
</code></pre>

<p>위 소스는 모든 인증 요청을 통과시킵니다.</p>

<h3 id="설정">설정</h3>

<p>node.js용 인증모듈을 /etc/ejabberd/external_auth/node 디렉토리에 auth.js 파일이름으로 작성합니다.</p>

<p>package.json파일을 작성하지 않을 경우 다음과 같이 ejabberd-auth 모듈을 인스톨합니다.</p>

<pre><code>      
npm install ejabberd-auth
  
</code></pre>

<p>/etc/ejabberd/ejabberd.yml파일을 열고 auth_method를 다음과 같이 수정합니다.</p>

<pre><code>      
auth_method: external
      
extauth\_program: &quot;node /etc/ejabberd/external\_auth/node/auth.js&quot;
  
</code></pre>

<p>ejabberd를 재실행하면 모든 인증요청이 통과됩니다.</p>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        
        <time class="post-date" datetime="2015-01-21T00:00:00Z">
            21 Jan 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/01/21/ejabberd-ec99b8ebb680-ec9db8eca69d-ebaaa8eb9388eab3bc-http-ecbba4ec8aa4ed8580-ebaaa8eb9388-ec97b0eb8f99/">ejabberd 외부 인증 모듈과 http 커스텀 모듈 연동</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            

<p>ejabberd의 외부 인증 모듈을 사용해서 인증 처리를 할 경우, 기존 멤버쉽과 연동하는 방법을 찾아 보도록 한다.</p>

<p>우선 들어가기에 앞서 작업 개요를 살펴보면 다음과 같다.</p>

<ul>
<li>python으로 외부 인증 모듈 작성</li>
<li>ejabberd를 외부에서 제어할 수 있도록 mod_http_api.erl 을 작성해 커스텀 모듈 등록</li>
<li>mod_http_api에서 기존 멤버쉽의 회원 정보 조회(편의상 internal rest api가 존재한다고 가정한다.)</li>
</ul>

<p>다음과 같은 로그인 처리 시나리오를 가정해 보자.</p>

<ol>
<li>로그인 할 경우 외부 인증 모듈에서 <a href="http://localhost:5280/api/auth?user=romeo&amp;server=localhost&amp;password=1234와">http://localhost:5280/api/auth?user=romeo&amp;server=localhost&amp;password=1234와</a> 같은 형식으로 호출한다.</li>
<li>mod_http_api에서 ejabberd 모듈을 사용해 유저를 로그인 처리한다.</li>
<li>ejabberd에 없을 경우, 멤버쉽에서 해당 유저를 조회한다.

<ol>
<li>멤버쉽에 해당 유저가 있을 경우, 가져와서 ejabberd에 등록한다.</li>
<li>멤버쉽에 해당 유저가 없다면 로그인 실패한다.</li>
</ol></li>
<li>ejabberd에 있을 경우, 암호를 확인해 로그인 처리한다.</li>
</ol>

<h2 id="mod-http-api-erl-작성">mod_http_api.erl 작성</h2>

<h3 id="기본-골격-코드-작성">기본 골격 코드 작성</h3>

<p>먼저 기본 골격 코드는 다음과 같다.</p>

<pre><code class="language-erlang">      
-module(mod\_http\_api).
      
-author('your@email.org').
      
-vsn('').
      
-define(ejabberd_debug, true).

-behaviour(gen_mod).

-export([
          
start/2,
          
stop/1,
          
process/2
          
]). 

-include(&quot;ejabberd.hrl&quot;).
      
-include(&quot;jlib.hrl&quot;).
      
-include(&quot;ejabberd_http.hrl&quot;).
      
-include(&quot;logger.hrl&quot;).
      
-include(&quot;http_bind.hrl&quot;).

%%%&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;-
      
%%% REQUEST HANDLERS
      
%%%&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;-

process([&lt;&gt;], _Request) -&gt;
          
?DEBUG(&quot;Hello Request: ~p&quot;, [_Request]),
          
{200, ?HEADER,
           
#xmlel{name = &lt;&gt;, children = [{xmlcdata, &lt;&gt;}]}}.

process(\_Path, \_Request) -&gt;
          
?DEBUG(&quot;Bad Request: ~p, ~p&quot;, [\_Path, \_Request]),
          
{400, ?HEADER,
           
#xmlel{name = &lt;&gt;, children = [{xmlcdata, &lt;&gt;}]}}.

%%%&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;-
      
%%% BEHAVIOUR CALLBACKS
      
%%%&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;-

start(\_Host, \_Opts) -&gt;
          
ok.

stop(_Host) -&gt;
          
ok.
  
</code></pre>

<p>ejabberd/src/ 밑에 mod_http_api.erl 파일명으로 저장한다.</p>

<p>위와 같이 작성한 후 ejabberd.yml을 다음과 같이 수정한다.</p>

<pre><code class="language-erlang">      
listen:
        
&amp;#8230;(중간 생략)
        
request_handlers:
          
&quot;/api&quot;: mod\_http\_api

&amp;#8230;(중간 생략)

modules:
        
&amp;#8230;(중간 생략)
        
mod_version: {}
        
mod\_http\_api: {}
  
</code></pre>

<p>make &amp; make install을 사용해서 다시 빌드한 후 ejabberd를 기동한다.</p>

<p>웹브라우저를 띄우고 <a href="http://localhost:5280/api/hello(편의상">http://localhost:5280/api/hello(편의상</a> 이후에는 /api/hello와 같이 줄여서 사용함)에 접속하면 &#8220;Hello World~!!!&#8221; XML 문자열이 브라우저에 출력된다.</p>

<p>여기까지 무사히 진행했다면 본격적으로 시작해 보자.</p>

<h3 id="auth-api-작성">auth api 작성</h3>

<p>/api/auth?user=romeo&amp;server=localhost&amp;password=1234와 같은 api 호출을 받아드리도록 process/2 함수를 확장한다.</p>

<pre><code class="language-erlang">      
process([&lt;&gt;], _Request) -&gt;
          
Args = element(4, _Request),
          
User = proplists:get_value(&lt;&gt;, Args),
          
Server = proplists:get_value(&lt;&gt;, Args),
          
Pwd = proplists:get_value(&lt;&gt;, Args),
          
IsExists = ejabberd\_auth\_internal:is\_user\_exists(User, Server),
          
Result = to\_bin(&quot;~p ~n user=~p, server=~p, pwd=~p is\_exists=~p ~n&quot;, [_Request, User, Server, Pwd, IsExists]),
          
?DEBUG(&quot;Auth Request: ~p&quot;, [Args]),
          
{200, ?HEADER,Result};

to_bin(Format, List) -&gt;
          
binary:list\_to\_bin(io_lib:format(Format, List)).
  
</code></pre>

<blockquote>
<p>to_bin/2 함수는 유틸 함수로 편의상 임의로 작성한 함수이다.</p>
</blockquote>

<p>_Request를 출력해보면 다음과 같은 튜플을 확인할 수 있다.</p>

<pre><code class="language-erlang">      
{request,'GET',
               
[&lt;&gt;,&lt;&gt;],
               
[{&lt;&gt;,&lt;&gt;},
                
{&lt;&gt;,&lt;&gt;},
                
{&lt;&gt;,&lt;&gt;}],
               
{&lt;&gt;,&lt;&gt;},
               
{&lt;&gt;,&lt;&gt;},
               
&lt;&gt;,&lt;&gt;,
               
{ {10,0,2,2},53260},
               
&lt;&gt;,5280,http,
               
[{'Accept-Language',&lt;&gt;},
                
{'Accept-Encoding',&lt;&gt;},
                
{'User-Agent',&lt;&gt;},
                
{'Accept',&lt;&gt;},
                
{'Authorization',&lt;&gt;},
                
{'Cache-Control',&lt;&gt;},
                
{'Connection',&lt;&gt;},
                
{'Host',&lt;&gt;}]}
  
</code></pre>

<p>위의 튜플 요소 중에 중요한 것은 네 번째 요소인 query string을 파싱한 결과인 파라미터 튜플 리스트이다.</p>

<pre><code class="language-erlang">      
[{&lt;&gt;,&lt;&gt;},
       
{&lt;&gt;,&lt;&gt;},
       
{&lt;&gt;,&lt;&gt;}]
  
</code></pre>

<p>_Request에서 해당 요소만 추출하기 위해서 element/2 함수를 다음과 같이 사용한다.</p>

<pre><code class="language-erlang">      
Args = element(4, _Request),
  
</code></pre>

<p>Args에 원하는 파라미터 튜플 리스트가 매치되고, Args에서 &ldquo;user&rdquo;, &ldquo;server&rdquo;, &ldquo;password&rdquo; 파라미터에 해당하는 값을 다음과 같이 추출할 수 있다.</p>

<pre><code class="language-erlang">      
User = proplists:get_value(&lt;&gt;, Args),
      
Server = proplists:get_value(&lt;&gt;, Args),
      
Pwd = proplists:get_value(&lt;&gt;, Args),
  
</code></pre>

<p>proplists 모듈의 get_value/2 함수를 사용하면 튜플 리스트에서 key/value로 값을 조회할 수 있다.</p>

<p>위의 과정을 거치면 User, Server, Pwd 변수에 각각 &lt;&lt;&ldquo;romeo&rdquo;&gt;&gt;, &lt;&lt;&ldquo;localhost&rdquo;&gt;&gt;, &lt;&lt;&ldquo;1234&rdquo;&gt;&gt; 바이너리 리스트가 할당된다.</p>

<p>이제 이 값을 가지고 이후의 과정을 처리하면 된다.</p>

<h4 id="ejabberd-유저-체크">ejabberd 유저 체크</h4>

<p>해당 유저가 ejabberd에 등록된 유저인지 확인해 보자.</p>

<p>다음과 같이 ejabberd_auth_internal 모듈의 is_user_exists/2 함수를 사용한다.</p>

<pre><code class="language-erlang">      
IsExists = ejabberd\_auth\_internal:is\_user\_exists(User, Server),
  
</code></pre>

<p>user가 존재한다면 IsExists 변수에는 true가, 아닐 경우 false가 바운드된다.</p>

<p><strong>ejabberd에 등록되지 않은 유저일 경우</strong></p>

<p>이 부분 이후는 다음 글에서 이어서 작성하도록 한다.</p>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        
        <time class="post-date" datetime="2015-01-21T00:00:00Z">
            21 Jan 2015
        </time>
    </footer>
</article>

	
	   
<article class="post posts">
    <header class="post-header">
        <h2 class="post-title"><a href="/2015/01/21/ejabberdec9790-json-eb9dbcec9db4ebb88ceb9faceba6acjiffy-ecb694eab080/">ejabberd에 json 라이브러리(jiffy) 추가</a></h2>
    </header>
    <section class="post-excerpt">
      <p>
          <section class="post-content">
            <p>ejabberd에서 json 라이브러리를 사용하려면 jiffy를 사용하면 된다.</p>

<p>ejabberd가 설치될 때 의존성을 걸어 함께 설치되도록 하려면 다음과 같이 configure에서 &#8211;enable-json을 추가해 주면 된다.</p>

<pre><code>      
./configure &amp;#8211;prefix={&amp;#8230;} &amp;#8211;enable-json
  
</code></pre>

<p>위와 같이 설치하려면 configure를 해 준 후에 rebar를 사용해 의존 라이브러리를 다운로드 받아야 하는데, 다음과 같이 처리한다.</p>

<pre><code>      
rebar get-deps
      
rebar compile
  
</code></pre>

<p>그런 후 make &amp; make install을 실행하자.</p>

<p>만약 jiffy.so 파일의 경로를 찾지 못하는 에러가 발생할 경우 다음과 같이 Makeifle.in 파일을 수정하면 된다.</p>

<p>관련 이슈는 다음 링크에서 확인할 수 있다.</p>

<p><a href="https://github.com/processone/ejabberd/commit/b550f247e74e86cac20027b8527e3ddd209837bc">https://github.com/processone/ejabberd/commit/b550f247e74e86cac20027b8527e3ddd209837bc</a></p>

<pre><code>          
\# Binary system libraries
          
$(INSTALL) -d $(SODIR)
          
$(INSTALL) -m 644 $(DLLs) $(SODIR)
      
+ [ -f $(SODIR)/jiffy.so ] &amp;&amp; (cd $(PRIVDIR); ln -sf lib/jiffy.so;)
          
#
          
\# Translated strings
          
$(INSTALL) -d $(MSGSDIR)
  
</code></pre>

<p>원래는 ln -s lib/jiffy.so 로 되어 있지만, 그럴 경우 설치된 후 재설치하려고 할 경우 이미 존재하는 심볼릭링크 에러를 뱉으며 make가 실패된다.</p>

<p>ls -sf &#8230;로 바꾼다.</p>

<p>제대로 설치되었는지 확인하려면 ejabberdctl debug로 디버그 쉘을 생성한 후 다음과 같이 모듈이 정상적으로 올라왔는지 확인한다.</p>

<pre><code class="language-erlang">      
(ejabberd@localhost)2&gt; m(jiffy).
      
Module jiffy compiled: Date: December 19 2014, Time: 06.33
      
Compiler options: [{outdir,&quot;ebin&quot;},debug_info,{i,&quot;include&quot;}]
      
Object file: /home/chshin/work/server/bin/lib/ejabberd/ebin/jiffy.beam
      
Exports:
               
decode/1
               
decode/2
               
encode/1
               
encode/2
               
module_info/0
               
module_info/1
      
ok
  
</code></pre>

<p>jiffy만 단독으로 테스트해 보고자 한다면 다음과 같이 erlang shell을 시작해서 테스트해볼 수 있다.</p>

<p>(jiffy는 현재 경로 기준으로 ../../deps/jiffy에 있고 컴파일되어 있다고 가정한다.)</p>

<pre><code>      
$ erl -pa ../../deps/jiffy/ebin ../../deps/jiffy
      
&gt; application:start(jiffy).
      
&gt; m(jiffy).
      
&gt; jiffy:encode(&quot;test&quot;).
  
</code></pre>

          </section>
      </p>
      
    </section>
    <footer class="post-meta">
        
        
        
            
        
        
        <time class="post-date" datetime="2015-01-21T00:00:00Z">
            21 Jan 2015
        </time>
    </footer>
</article>

	

	<nav class="pagination" role="navigation">
	
	    <a class="newer-posts" href="/categories/ejabberd/page/3/">&larr; Newer Posts</a>
	
	<span class="page-number">Page 4 of 4</span>
	
</nav>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Erlang &amp; Go</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://jeidee.github.iojs/index.js"></script>

</body>
</html>

